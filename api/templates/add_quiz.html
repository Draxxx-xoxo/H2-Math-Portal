<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        MathJax = {
          loader: {load: ['input/asciimath', 'output/chtml', 'ui/menu']},
          asciimath: {
            delimiters: [['$','$'], ['`','`']]
        }}
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-black text-white min-h-screen flex flex-col items-center justify-center">
    {% include 'partials/nav.html' %}
    <div class="container mx-auto p-4">
        <h2 class="text-2xl font-bold mb-4">Add New Quiz</h2>
        <form id="add-quiz-form" class="space-y-4">
            <div>
                <label for="quiz-title" class="block mb-2">Quiz Title:</label>
                <input type="text" id="quiz-title" name="quiz_title" class="bg-gray-800 text-white p-2 rounded w-full">
            </div>
            <div>
                <label for="quiz-description" class="block mb-2">Description:</label>
                <textarea id="quiz-description" name="quiz_description" class="bg-gray-800 text-white p-2 rounded w-full"></textarea>
            </div>
            <div>
                <label for="questions" class="block mb-2">Select Questions:</label>
                <div id="questions-list" class="space-y-2 bg-gray-800 p-4 rounded"></div>
            </div>
            <div>
                <input type="submit" value="Add Quiz" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            </div>
        </form>
    </div>
    <script>

        var supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: questions, error } = await supabase
                .from('question')
                .select('*');

            if (error) {
                console.error('Error fetching questions:', error);
                return;
            }

            const questionsList = document.getElementById('questions-list');
            questions.forEach(question => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `question-${question.id}`;
                checkbox.name = 'questions';
                checkbox.value = question.id;
                checkbox.className = 'mr-2';

                const label = document.createElement('label');
                label.htmlFor = `question-${question.id}`;
                label.innerHTML = question.question;
                label.className = 'block';

                const questionDiv = document.createElement('div');
                questionDiv.className = 'flex items-center';
                questionDiv.appendChild(checkbox);
                questionDiv.appendChild(label);

                questionsList.appendChild(questionDiv);
            });

            MathJax.typesetPromise([questionsList]).catch((err) => console.log(err.message));
        });

        const form = document.getElementById('add-quiz-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const title = form.quiz_title.value;
            const description = form.quiz_description.value;
            const selectedQuestions = Array.from(form.elements.questions)
                .filter(input => input.checked)
                .map(input => input.value);

            try {
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .insert([{ title, description }])
                    .single();

                if (quizError) throw quizError;

                const quizId = quiz.id;

                const quizQuestions = selectedQuestions.map(questionId => ({
                    quiz_id: quizId,
                    question_id: questionId
                }));

                const { error: quizQuestionsError } = await supabase
                    .from('quiz_questions')
                    .insert(quizQuestions);

                if (quizQuestionsError) throw quizQuestionsError;

                alert('Quiz added successfully!');
            } catch (error) {
                console.error('Error adding quiz:', error);
                alert('Error adding quiz: ' + error.message);
            }
        });

    </script>
    {% include 'partials/footer.html' %}
</body>
</html>
